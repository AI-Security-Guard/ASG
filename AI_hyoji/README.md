# ğŸ¥ ì´ìƒí–‰ë™ API

ì—…ë¡œë“œëœ ì˜ìƒì„ ë¶„ì„í•˜ì—¬ í­í–‰ êµ¬ê°„ì„ ìë™ ê°ì§€í•˜ëŠ” AI  ëª¨ë¸ì…ë‹ˆë‹¤. Flask ê¸°ë°˜ APIë¡œ êµ¬ì„±ë˜ì–´ ìˆìœ¼ë©°, DFWSGAR ëª¨ë¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

---
## ğŸ“ í´ë” êµ¬ì¡°
* `GPU / CPU` ì„¤ì •ì€ `analyze.py` 139ë²ˆì§¸ ì¤„ì—ì„œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤.
```
AI_hyoji/
â”œâ”€â”€ app.py                    # Flask ì„œë²„ ì§„ì…ì 
â”œâ”€â”€ analyze.py                # ì¶”ë¡ /ë¶„ì„ ì—”ì§„
â”œâ”€â”€ routes.py                 # API ë¼ìš°íŒ…
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ utils.py              # ì‹œê°í™”/í›„ì²˜ë¦¬ ìœ í‹¸
â”œâ”€â”€ model/
â”‚   â””â”€â”€ best_model.pth        # í•™ìŠµëœ PyTorch ëª¨ë¸ ê°€ì¤‘ì¹˜
â”‚   â””â”€â”€ best_threshold.txt    # assault íŒì • í™•ë¥  ì„ê³„ê°’(ë‹¤ì¤‘ í´ë˜ìŠ¤ ì‹œ ì¶”ê°€ ì˜ˆì •)
â”œâ”€â”€ models/                   # ë…¼ë¬¸ ì°¸ê³ í•œ DFWSGARëª¨ë¸ ì •ì˜
â”œâ”€â”€ analyzed_videos/          # ë¶„ì„ëœ ì˜ìƒ í´ë”(ì‹¤í–‰ ì‹œ ë””ìŠ¤í¬ì— ìë™ ìƒì„±)
â”œâ”€â”€ clip_summaries/           # ë¶„ì„ëœ ì´ìƒí–‰ë™ í´ë¦½ ì •ë³´ í´ë”(ì‹¤í–‰ ì‹œ ë””ìŠ¤í¬ì— ìë™ ìƒì„±)
â”œâ”€â”€ event_clips/              # ë¶„ì„ëœ ì´ìƒí–‰ë™ í´ë¦½ í´ë”(ì‹¤í–‰ ì‹œ ë””ìŠ¤í¬ì— ìë™ ìƒì„±)
â”œâ”€â”€ jobs.db                   # SQLite DB, ê²°ê³¼ ë‚´ìš©ì„ ì €ì¥í•˜ëŠ” DB
â””â”€â”€ requirements.txt          # python ë²„ì „ê³¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „
```

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### ì„œë²„ ì‹¤í–‰
```
bash

python app.py
```

---
## ğŸ§ª API ì‚¬ìš©ë²•


### 1. `/analyze` - ë¶„ì„ ì‹¤í–‰
- `POST /analyze`ë¡œ JSON ë°ì´í„°ë¥¼ ë³´ë‚´ë©´ ë¶„ì„ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.

```
POST /analyze
Content-Type: application/json

{
  "video_path": "uploads/sample.mp4"
}
```
<br>

#### ì‘ë‹µ ì˜ˆì‹œ
* job_idëŠ” ëª¨ë¸ ì‹¤í–‰ ì‹œ ë¶€ì—¬ë˜ëŠ” 'ê³ ìœ  id' ì…ë‹ˆë‹¤.
```
json

{
  "job_id": "e7034efc-1b24-4288-b7f2-37118b8123f6"
}
```
<br><br>

### 2. `/jobs/<job_id>` - ê²°ê³¼ ì¡°íšŒ
- `GET /jobs/<job_id>`ë¡œ job_idë¥¼ ì…ë ¥í•˜ì—¬ DBì— ì €ì¥í•œ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```
GET /jobs/<job_id>

curl ì„œë²„ì£¼ì†Œ/jobs/e7034efc-1b24-4288-b7f2-37118b8123f6(job_id)
```
<br>

### ì‘ë‹µ ì˜ˆì‹œ
##### 1) ë¶„ì„ ì§„í–‰ ì¤‘
```
json

{
  "job_id": "e7034efc-1b24-4288-b7f2-37118b8123f6",
  "progress":40.0323877839365285, # 40% ì§„í–‰ì¤‘
  "results": null
}
```
<br>

##### 2) ë¶„ì„ ì™„ë£Œ
```
json

{
  "job_id": "e7034efc-1b24-4288-b7f2-37118b8123f6",
  "results": {
    "video_path": "uploads/sample.mp4",
    "annotated_video": "analyzed_videos/sample_analyze.mp4",
    "num_clips": 3,
    "clips_info_json": "clip_summaries/sample_clips.json"
  }
}
```
| í•„ë“œëª…             | íƒ€ì…    | ì„¤ëª…                                      |
|--------------------|---------|-----------------------------------------|
| `video_path`       | string  | ë¶„ì„ì— ì‚¬ìš©ëœ ì›ë³¸ ì˜ìƒ ê²½ë¡œ                        |
| `annotated_video`  | string  | ë¶„ì„ëœ ì˜ìƒ ê²½ë¡œ (ì˜ìƒëª… : `ì›ë³¸ì´ë¦„ + _analyze.mp4`) |
| `num_clips`        | integer | ìƒì„±ëœ ì´ìƒí–‰ë™ í´ë¦½ ê°œìˆ˜                          |
| `clips_info_json`  | string  | ì´ìƒí–‰ë™ í´ë¦½ ë©”íƒ€ì •ë³´ JSON íŒŒì¼ ê²½ë¡œ                 |


---
## ğŸ¬ clip_summaries 
* ì´ìƒí–‰ë™ í´ë¦½ì— ëŒ€í•œ ì •ë³´ `JSONíŒŒì¼`ì´ ì €ì¥ë©ë‹ˆë‹¤.
* JSONíŒŒì¼ëª…ì€ `ì›ë³¸ì˜ìƒëª… + _clip` ì…ë‹ˆë‹¤.
```
JSON íŒŒì¼ ë‚´ìš©
{
  "video": "uploads/sample.mp4",
  "num_clips": 3,
  "clips": [
    {
      "clip_id": 1,
      "class_name": "assault",
      "start_time": "00:00:12",
      "start_bbox": [312, 118, 470, 236],
      "clip_name": "sample_clip1.mp4",
      "clip_path": "event_clips/sample_clip1.mp4"
    }
  ]
}
```
| í•„ë“œëª…        | íƒ€ì…             | ì„¤ëª…                                    |
|---------------|------------------|---------------------------------------|
| `clip_id`     | integer          | í´ë¦½ ê³ ìœ  ë²ˆí˜¸(1ë¶€í„° ì¦ê°€)                      |
| `class_name`  | string           | ì´ìƒí–‰ë™ í´ë˜ìŠ¤(ì˜ˆ: `assault`)                |
| `start_time`  | string           | ì´ìƒí–‰ë™ ì‹œì‘ ì‹œê°(HH:MM:SS, ì›ë³¸ ì˜ìƒ ê¸°ì¤€)        |
| `start_bbox`  | array \| null    | ì‹œì‘ í”„ë ˆì„ ë°•ìŠ¤ `[x1,y1,x2,y2]` (ì›ë³¸ í•´ìƒë„ ì¢Œí‘œ) |
| `clip_name`   | string           | í´ë¦½ëª…(ì˜ˆ: `<ì›ë³¸>_clip1.mp4`(1ë¶€í„° ì¦ê°€))      |
| `clip_path`   | string           | í´ë¦½ íŒŒì¼ ê²½ë¡œ                              |

---
## ğŸ“¦ DB í…Œì´ë¸” ì •ì˜

### í…Œì´ë¸”: `jobs`
| ì»¬ëŸ¼ëª…     | íƒ€ì… | PK | NULL í—ˆìš© | ì„¤ëª…                                |
|-----------|------|----|-----------|-------------------------------------|
| `job_id`  | TEXT | âœ… | âŒ        | ì‘ì—… ì‹ë³„ì(UUID)                   |
| `payload` | TEXT | âŒ | âŒ        | ìµœì†Œ ê²°ê³¼ JSON ë¬¸ìì—´(UTF-8 ì €ì¥)   |

<br>

### ìŠ¤í‚¤ë§ˆ(SQL)
```sql
CREATE TABLE IF NOT EXISTS jobs(
  job_id  TEXT PRIMARY KEY,
  payload TEXT NOT NULL
);
```
<br>

### `payload` JSON êµ¬ì¡°

#### ìµœìƒìœ„
| í•„ë“œëª…     | íƒ€ì…             | ì„¤ëª…                               |
|------------|------------------|------------------------------------|
| `job_id`   | string           | ì‘ì—… ì‹ë³„ì(UUID)                  |
| `results`  | object \| null   | ì™„ë£Œ ì‹œ ê°ì²´, ì§„í–‰ ì¤‘ì´ë©´ `null`   |

<br>

#### `results` ê°ì²´ (ì™„ë£Œ ì‹œ)
| í•„ë“œëª…             | íƒ€ì…    | ì„¤ëª…                      |
|--------------------|---------|-------------------------|
| `video_path`       | string  | ë¶„ì„ì— ì‚¬ìš©ëœ ì›ë³¸ ì˜ìƒ ê²½ë¡œ        |
| `annotated_video`  | string  | ë¶„ì„ëœ ì˜ìƒ ê²½ë¡œ               |
| `num_clips`        | integer | ìƒì„±ëœ ì´ìƒí–‰ë™ í´ë¦½ ê°œìˆ˜          |
| `clips_info_json`  | string  | ì´ìƒí–‰ë™ í´ë¦½ ë©”íƒ€ì •ë³´ JSON íŒŒì¼ ê²½ë¡œ |

<br>

### ì˜ˆì‹œ ë ˆì½”ë“œ (ìš”ì•½)
| job_id (ì˜ˆì‹œ)                         | payload ìš”ì•½ |
|--------------------------------------|--------------|
| `e7034efc-1b24-4288-b7f2-37118b8123f6` | <code>{"job_id":"id ìƒëµ","results":null}</code> |
| `e9012b42-4d2f-47b8-bfd8-5f9d1274074a` | <code>{"job_id":"id ìƒëµ","results":{"video_path":"uploads/sample.mp4",<br>"annotated_video":"analyzed_videos/sample_analyze.mp4","num_clips":3,<br>"clips_info_json":"clip_summaries/sample_clips.json"}}</code> |


---
## ğŸ›  ê¸°íƒ€ ì°¸ê³  ì‚¬í•­

- ì˜ìƒ ë¶„ì„ì€ í‰ê·  7~10ë¶„ ë‚´ì™¸ ì†Œìš”ë©ë‹ˆë‹¤. (FHD 5ë¶„ ì˜ìƒ ê¸°ì¤€)
- ì»´í“¨í„° ì‚¬ì–‘(ì„œë²„)ì— ë”°ë¼ì„œ ë” ì§§ê±°ë‚˜ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ“„ requirements.txt
- python ë²„ì „ë„ ìƒë‹¨ì— ì¶”ê°€ëœ ìƒíƒœì…ë‹ˆë‹¤.
- ê°€ìƒí™˜ê²½ì— ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‹¤ ë“¤ì–´ê°€ìˆì–´ì„œ í•„ìš”ì—†ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë„ ì„ì—¬ìˆìŠµë‹ˆë‹¤.
- spatial_correlation_sampler ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì œì™¸ë˜ì–´ìˆì–´ í•„ìš”ì‹œ ê° í†¡ì£¼ì„¸ìš”.
```
bash

pip install requirements.txt
```




